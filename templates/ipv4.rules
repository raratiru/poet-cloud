# Generated by xtables-save v1.8.2 on Wed May 20 22:26:38 2020
*filter
:managed_input - [0:0]
:managed_output - [0:0]
:managed_martians - [0:0]
:managed_smurfs - [0:0]
:managed_tcpflags - [0:0]
:managed_icmp - [0:0]
:all_input - [0:0]
:all_output - [0:0]
:log_ssh - [0:0]
:net_input - [0:0]
:drop_input_log - [0:0]
:drop_output_log - [0:0]
:net_output - [0:0]
:loc_input - [0:0]
:loc_output - [0:0]
:web_server - [0:0]

-A managed_input -s {{ ansible_facts.default_ipv4.address }}/32 -m comment --comment "Prevent Land Attack" -j DROP
-A managed_input -i lo -m comment --comment "Allow loopback" -j ACCEPT
-A managed_input -i {{ ansible_facts.default_ipv4.interface }} -j net_input
{% if dmz_interface is defined %}-A managed_input -i {{ dmz_interface }} -j loc_input {% endif %}
-A managed_input -j drop_input_log
-A managed_output -o lo -m comment --comment "Allow loopback" -j ACCEPT
-A managed_output -o {{ ansible_facts.default_ipv4.interface }} -j net_output
{% if dmz_interface is defined %}-A managed_output -o {{ dmz_interface }} -j loc_output{% endif%}
-A managed_output -j drop_output_log
-A managed_martians -s 0.0.0.0/8 -m comment --comment "\'This\' network" -j DROP
-A managed_martians -s 10.0.0.0/8 -m comment --comment "Private-use networks" -j DROP
-A managed_martians -s 100.64.0.0/10 -m comment --comment "Carrier-grade NAT" -j DROP
-A managed_martians -s 127.0.0.0/8 -m comment --comment Loopback -j DROP
-A managed_martians -s 169.254.0.0/16 -m comment --comment "Link local" -j DROP
-A managed_martians -s 172.16.0.0/12 -m comment --comment "Private-use networks" -j DROP
-A managed_martians -s 192.0.0.0/24 -m comment --comment "IETF protocol assignments" -j DROP
-A managed_martians -s 192.0.2.0/24 -m comment --comment TEST-NET-1 -j DROP
-A managed_martians -s 192.168.0.0/16 -m comment --comment "Private-use networks" -j DROP
-A managed_martians -s 198.18.0.0/15 -m comment --comment "Network interconnect device benchmark testing" -j DROP
-A managed_martians -s 198.51.100.0/24 -m comment --comment TEST-NET-2 -j DROP
-A managed_martians -s 203.0.113.0/24 -m comment --comment TEST-NET-3 -j DROP
-A managed_martians -s 240.0.0.0/4 -m comment --comment "Reserved for future use" -j DROP
-A managed_martians -s 255.255.255.255/32 -m comment --comment "Limited broadcast" -j DROP
-A managed_martians -m addrtype --src-type BROADCAST -j DROP
-A managed_martians -s 224.0.0.0/4 -m comment --comment Multicast -j DROP
-A managed_tcpflags -p tcp -m tcp ! --tcp-flags FIN,SYN,RST,ACK SYN -m state --state NEW -m comment --comment "NEW Packets should start with SYN" -j DROP
-A managed_tcpflags -p tcp -m tcp --sport 0 --tcp-flags FIN,SYN,RST,ACK SYN -m comment --comment "Attacks From Shorewall Rules" -j DROP
-A managed_tcpflags -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -m comment --comment "NULL packets" -j DROP
-A managed_tcpflags -p tcp -m tcp ! --tcp-flags FIN,SYN,RST,ACK SYN -m comment --comment "SYN flag checking" -j DROP
-A managed_tcpflags -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,SYN,RST,PSH,ACK,URG -m comment --comment "XMAS packets" -j DROP
-A managed_tcpflags -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,PSH,URG -m comment --comment "Attacks From Shorewall Rules" -j DROP
-A managed_tcpflags -p tcp -m tcp --tcp-flags SYN,RST SYN,RST -m comment --comment "Attacks From Shorewall Rules" -j DROP
-A managed_tcpflags -p tcp -m tcp --tcp-flags FIN,RST FIN,RST -m comment --comment "Attacks From Shorewall Rules" -j DROP
-A managed_tcpflags -p tcp -m tcp --tcp-flags FIN,SYN FIN,SYN -m comment --comment "Attacks From Shorewall Rules" -j DROP
-A managed_tcpflags -p tcp -m tcp --tcp-flags FIN,PSH,ACK FIN,PSH -m comment --comment "Attacks From Shorewall Rules" -j DROP
-A managed_tcpflags -p tcp -m tcp --tcp-flags FIN,ACK FIN -m comment --comment "Attacks From Hardened Conf github" -j DROP
-A managed_tcpflags -p tcp -m tcp --tcp-flags ACK,URG URG -m comment --comment "Attacks From Hardened Conf github" -j DROP
-A managed_icmp -m limit --limit 1/sec --limit-burst 3 -j ACCEPT
-A managed_icmp -j DROP
-A all_input -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A all_input -m conntrack --ctstate INVALID -j DROP
-A all_input -p icmp -j managed_icmp
-A all_input -p tcp -j managed_tcpflags
-A all_input -m addrtype --dst-type BROADCAST -j DROP
-A all_input -m addrtype --dst-type MULTICAST -j DROP
-A all_input -m addrtype --dst-type ANYCAST -j DROP
-A all_output -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A all_output -p icmp -j managed_icmp
-A all_output -m addrtype --dst-type BROADCAST -j DROP
-A all_output -m addrtype --dst-type MULTICAST -j DROP
-A all_output -m addrtype --dst-type ANYCAST -j DROP
-A log_ssh -m hashlimit --hashlimit-upto 1/sec --hashlimit-burst 10 --hashlimit-mode srcip --hashlimit-name lograte -j LOG --log-prefix "IPT: SSH" --log-level 6
-A log_ssh -m limit --limit 1/sec --limit-burst 3 -j ACCEPT
-A log_ssh -j DROP
-A net_input -m conntrack --ctstate NEW,UNTRACKED -j managed_martians
-A net_input -j all_input
-A net_input -p tcp -m tcp --dport 22 -m comment --comment "Allow SSH" -j log_ssh
-A net_input -p tcp -m tcp --dport 80 -m comment --comment "Allow WEB" -j web_server
-A net_input -p tcp -m tcp --dport 443 -m comment --comment "Allow SECURE WEB" -j web_server
-A net_input -p udp -m udp --dport 67:68 -m comment --comment "Allow DHCP" -j ACCEPT
-A drop_input_log -m hashlimit --hashlimit-upto 1/sec --hashlimit-burst 10 --hashlimit-mode srcip --hashlimit-name lograte -j LOG --log-prefix "IPT: DROP OUTPUT" --log-level 6
-A drop_input_log -j DROP
-A drop_output_log -m hashlimit --hashlimit-upto 1/sec --hashlimit-burst 10 --hashlimit-mode srcip --hashlimit-name lograte -j LOG --log-prefix "IPT: DROP OUTPUT" --log-level 6
-A drop_output_log -j DROP
-A net_output -j all_output
-A net_output -p udp -m udp --dport 67:68 -m comment --comment "Allow DHCP" -j ACCEPT
-A net_output -p udp -m udp --dport 123 -m comment --comment "Allow ntp" -j ACCEPT
-A net_output -p udp -m udp --dport 53 -m comment --comment "Allow DNS UDP" -j ACCEPT
-A net_output -p tcp -m tcp --dport 53 -m comment --comment "Allow DNS TCP" -j ACCEPT
-A net_output -p tcp -m tcp --dport 21 -m comment --comment "Allow ftp" -j ACCEPT
-A net_output -p tcp -m tcp --dport 25 -m comment --comment "Allow outgoing emails" -j ACCEPT
-A net_output -p tcp -m tcp --dport 80 -m comment --comment "Allow outgoing web" -j ACCEPT
-A net_output -p tcp -m tcp --dport 443 -m comment --comment "Allow outgoing secure web" -j ACCEPT
-A net_output -p tcp -m tcp --dport 22 -m comment --comment "Allow SSH" -j log_ssh
-A net_output -p tcp -m tcp --dport 587 -m comment --comment "Allow outgoing to Email Server" -j ACCEPT
-A loc_input -j all_input
-A loc_output -j all_output
-A loc_output -p tcp -m tcp --dport 22 -m comment --comment "Allow SSH" -j log_ssh
-A web_server -m hashlimit --hashlimit-upto 30/min --hashlimit-burst 15 --hashlimit-mode srcip --hashlimit-name web_server_limit --hashlimit-htable-expire 300000 -j ACCEPT
-A web_server -j DROP
COMMIT
