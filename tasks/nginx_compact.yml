---
- name: copy necessary templates
  template:
    src: "{{ item.source }}"
    dest: "{{ item.destination }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  become: True
  with_items:
    # - {
    #     source: nginx.conf_pre.j2,
    #     destination: /etc/nginx/nginx.conf,
    #     owner: root,
    #     group: root,
    #     mode: "0640",
    #   }
    - {
        source: nginx_site.conf_pre.j2,
        destination: "/etc/nginx/conf.d/{{ server_domain_name }}.conf",
        owner: root,
        group: root,
        mode: "0640",
      }

- name: "Nginx: Open admin directory"
  become: True
  ansible.builtin.blockinfile:
    path: "/etc/nginx/conf.d/{{ server_domain_name }}.conf"
    insertbefore: "  location / {"
    block: |2
      location ~ /{{ django_admin_path }} {
        try_files $uri $uri/ @proxy;
      }

- name: "Nginx: Create html directory for this server"
  command: "git init {{ ansible_user_dir }}/00_server/{{ server_domain_name }}"
  args:
    creates: "{{ ansible_user_dir }}/00_server/{{ server_domain_name }}/.git/HEAD"

- name: "Nginx: Change permissions and group of the server directory"
  become: True
  file:
    path: "{{ ansible_user_dir }}/00_server/{{ server_domain_name }}"
    state: directory
    owner: "{{ ansible_ssh_user }}"
    group: nginx
    mode: "0750"

- name: "Nginx: Create .local/bin directory"
  become: True
  file:
    path: "{{ ansible_user_dir }}/.local/bin"
    state: directory
    owner: "{{ ansible_ssh_user }}"
    group: "{{ ansible_ssh_user }}"
    mode: "0700"

- name: "Nginx: Copy Maintenance Script Enable"
  become: True
  template:
    src: start_maintenance.j2
    dest: "{{ ansible_user_dir }}/.local/bin"
    owner: "{{ ansible_ssh_user }}"
    group: "{{ ansible_ssh_user }}"
    mode: "0700"

- name: "Nginx: Copy Maintenance Script Conclude"
  become: True
  template:
    src: conclude_maintenance.j2
    dest: "{{ ansible_user_dir }}/.local/bin"
    owner: "{{ ansible_ssh_user }}"
    group: "{{ ansible_ssh_user }}"
    mode: "0700"

- name: "Nginx: Copy Make Ready Script"
  become: True
  template:
    src: make_ready.j2
    dest: "{{ ansible_user_dir }}/.local/bin"
    owner: "{{ ansible_ssh_user }}"
    group: "{{ ansible_ssh_user }}"
    mode: "0700"

- name: "Change home directory permissions and group"
  become: True
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}"
    state: directory
    group: nginx
    mode: "0750"
